apiVersion: v1
kind: Namespace
metadata:
  name: storage-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: storage-controller
  namespace: storage-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: storage-controller
rules:
- apiGroups: [""]
  resources: ["pods", "persistentvolumeclaims", "persistentvolumes"]
  verbs: ["get", "list", "watch", "update", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets"]
  verbs: ["get", "list", "watch", "update", "patch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: storage-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: storage-controller
subjects:
- kind: ServiceAccount
  name: storage-controller
  namespace: storage-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: storage-tiering-policy
  namespace: storage-system
data:
  policy.yaml: |
    # Storage tiering rules
    tiers:
      hot:
        location: /tank/containers/active
        criteria:
          - last_accessed < 7d
          - status == running
          - owner_type in [faculty, staff, graduate]
        max_capacity: 8TB
        
      warm:
        location: /tank/containers/inactive
        criteria:
          - last_accessed >= 7d
          - last_accessed < 30d
          - status == stopped
        max_capacity: 5TB
        
      cold:
        location: /tank/archive/students
        criteria:
          - last_accessed >= 30d
          - semester_ended == true
        compression: zstd
        
    migration_schedule:
      hot_to_warm:
        cron: "0 3 * * *"  # Daily 3 AM
        bandwidth_limit: 100MB/s
        
      warm_to_cold:
        cron: "0 4 * * 0"  # Weekly Sunday 4 AM
        bandwidth_limit: 50MB/s
        
      reactivation:
        trigger: on_access
        priority_map:
          faculty: immediate
          graduate: 5m
          undergraduate: 15m
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: storage-tiering-controller
  namespace: storage-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: storage-tiering-controller
  template:
    metadata:
      labels:
        app: storage-tiering-controller
    spec:
      serviceAccountName: storage-controller
      nodeSelector:
        kubernetes.io/hostname: hydra
      containers:
      - name: controller
        image: busybox:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          #!/bin/sh
          echo "Storage Tiering Controller - Running on Hydra"
          echo "Checking storage tiers every hour..."
          
          while true; do
            echo "$(date): Checking container access times..."
            
            # Check containers on /tank/containers/active
            if [ -d /tank/containers/active ]; then
              for container in /tank/containers/active/*; do
                if [ -d "$container" ]; then
                  NAME=$(basename "$container")
                  LAST_ACCESS=$(stat -c %X "$container" 2>/dev/null || echo 0)
                  NOW=$(date +%s)
                  AGE=$((NOW - LAST_ACCESS))
                  DAYS=$((AGE / 86400))
                  
                  if [ $DAYS -gt 7 ]; then
                    echo "Container $NAME inactive for $DAYS days - candidate for migration"
                  fi
                fi
              done
            fi
            
            # Report storage usage
            echo "$(date): Storage usage report"
            df -h | grep tank
            
            # Sleep for 1 hour
            sleep 3600
          done
        volumeMounts:
        - name: tank-storage
          mountPath: /tank
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
      volumes:
      - name: tank-storage
        hostPath:
          path: /tank
          type: Directory
